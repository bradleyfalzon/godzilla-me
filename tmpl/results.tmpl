{{ template "header" . }}
{{ with .Result }}

<h1>Testing: {{ .Package }}</h1>
<p>Finished: {{ .Finished }} </p>

{{ if .Finished }}

<pre>
{{ .Results }}
</pre>

{{ else }}

<script>
var refreshCount = 100
var refreshInterval = 2000 // milliseconds

// getStatus gets the package's status from the API
function getStatus() {
    var r = new XMLHttpRequest();
    r.addEventListener("load", statusLoad);
    r.open("GET", "/api/status/{{ .Package }}");
    r.send();
}

// statusLoad handles the result from the status API
function statusLoad() {
    var resp = JSON.parse(this.responseText);
    console.log(resp)
    console.log(resp.Finished)
    if ( resp.Finished ) {
        location.reload();
        return
    }
    if ( refreshCount > 0 ) {
        window.refreshCount--
        window.setTimeout(getStatus, refreshInterval)
        return
    }
    alert("Took too long, giving up auto refreshing, please manually refresh to try again or retry later.")
}

getStatus();
</script>
{{ end }}

{{ end }}
{{ template "footer" . }}
